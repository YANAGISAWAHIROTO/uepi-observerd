<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>UEPI è¦³æ¸¬ç«¯æœ«</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;background:#0b0e12;color:#e6e6e6;font-family:monospace}
header{background:#111827;padding:14px;border-bottom:1px solid #2b2f36}
.container{padding:16px}
.panel{border:1px solid #2b2f36;background:#0f131a;padding:12px;margin-bottom:14px}
button{width:100%;padding:12px;background:#06080c;color:#e6e6e6;border:1px solid #2b2f36;font-size:16px}
.log{font-size:12px;background:#06080c;padding:8px;height:110px;overflow-y:auto}

.meter-wrap{
  width:100%;height:20px;background:#06080c;
  border:1px solid #2b2f36;margin-top:6px
}
.meter-bar{
  height:100%;width:0%;
  transition:width .8s ease;
  background:linear-gradient(90deg,#4ade80,#facc15,#f87171,#c084fc)
}
.meter-label{font-size:12px;opacity:.8;margin-top:4px}

.NOIS{color:#4ade80}
.MID{color:#facc15}
.HIGH{color:#f87171}
.CRITICAL{color:#c084fc}
</style>
</head>

<body>

<header>
<b>UEPI è¦³æ¸¬ãƒ»è§£æç«¯æœ«</b><br>
<span style="font-size:12px;color:#9aa4b2">
Unidentified Environmental Phenomena Institute
</span>
</header>

<div class="container">

<div class="panel">
<div>æœ€çµ‚åˆ¤å®š</div>
<div id="status" style="font-size:18px">æœªè¦³æ¸¬</div>
<div id="aid" style="font-size:13px;opacity:.7">---</div>
</div>

<div class="panel">
<button id="startBtn" onclick="startObservation()">â–¶ è¦³æ¸¬é–‹å§‹</button>
</div>

<div class="panel">
<div>å±é™ºåº¦ãƒ¡ãƒ¼ã‚¿ãƒ¼</div>
<div class="meter-wrap">
  <div id="meter" class="meter-bar"></div>
</div>
<div id="meterText" class="meter-label">0%</div>
</div>

<div class="panel">
<div>è¦³æ¸¬ãƒ­ã‚°</div>
<div id="log" class="log"></div>
</div>

</div>

<script>
let observing=false;
let results=[];
const TOTAL=5;

let warned70=false;
let warned90=false;

// --- Audio ---
let audioCtx=null;
function beep(freq,dur){
  if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  const osc=audioCtx.createOscillator();
  const gain=audioCtx.createGain();
  osc.frequency.value=freq;
  osc.type="sine";
  gain.gain.value=0.15;
  osc.connect(gain).connect(audioCtx.destination);
  osc.start();
  setTimeout(()=>osc.stop(),dur);
}

const log=document.getElementById("log");
const status=document.getElementById("status");
const aid=document.getElementById("aid");
const btn=document.getElementById("startBtn");
const meter=document.getElementById("meter");
const meterText=document.getElementById("meterText");

function logAdd(t){
  log.innerHTML+=`[${new Date().toLocaleTimeString()}] ${t}<br>`;
  log.scrollTop=log.scrollHeight;
}

function startObservation(){
  if(observing) return;
  observing=true;
  results=[];
  warned70=false;
  warned90=false;

  btn.disabled=true;
  btn.textContent="è¦³æ¸¬ä¸­â€¦";
  status.textContent="è¦³æ¸¬ä¸­â€¦";
  status.className="";
  aid.textContent="UEPI-OBS";
  meter.style.width="0%";
  meterText.textContent="0%";
  logAdd("è¦³æ¸¬é–‹å§‹");

  let step=0;
  const timer=setInterval(()=>{
    step++;
    const r=detect();
    results.push(r);
    logAdd(`ãƒ‡ãƒ¼ã‚¿å–å¾— â†’ ${r}`);
    updateMeter();
    if(step>=TOTAL){
      clearInterval(timer);
      finalize();
    }
  },1000);
}

function detect(){
  const pool=["NOIS","NOIS","MID","MID","HIGH","CRITICAL"];
  return pool[Math.floor(Math.random()*pool.length)];
}

function updateMeter(){
  const scoreMap={NOIS:0,MID:1,HIGH:2,CRITICAL:3};
  let sum=0;
  results.forEach(r=>sum+=scoreMap[r]);
  const percent=Math.round((sum/(TOTAL*3))*100);
  meter.style.width=percent+"%";
  meterText.textContent=percent+"%";

  if(percent>=70 && !warned70){
    beep(880,200);
    logAdd("âš  è­¦å‘Šãƒ¬ãƒ™ãƒ«åˆ°é”");
    warned70=true;
  }
  if(percent>=90 && !warned90){
    setTimeout(()=>beep(880,200),0);
    setTimeout(()=>beep(880,200),250);
    logAdd("ğŸš¨ å±é™ºãƒ¬ãƒ™ãƒ«åˆ°é”");
    warned90=true;
  }
}

function finalize(){
  observing=false;

  const freq={};
  results.forEach(r=>freq[r]=(freq[r]||0)+1);
  const final=Object.keys(freq).sort((a,b)=>freq[b]-freq[a])[0];

  const info={
    NOIS:["UEPI-000","ç•°å¸¸ãªã—"],
    MID:["UEPI-021","ç’°å¢ƒç•°éŸ³å¹²æ¸‰"],
    HIGH:["UEPI-071","å±€æ‰€ç¾å®Ÿæ­ªæ›²"],
    CRITICAL:["UEPI-â–ˆâ–ˆâ–ˆ","é‡å¤§æœªè§£æ˜æ€ªç•°"]
  };

  status.textContent=`${final}ï¼ˆ${info[final][1]}ï¼‰`;
  status.className=final;
  aid.textContent=info[final][0];
  logAdd("æœ€çµ‚åˆ¤å®šç¢ºå®š");

  btn.disabled=false;
  btn.textContent="â–¶ è¦³æ¸¬é–‹å§‹";
}
</script>

</body>
</html>
